<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>User Dashboard — Plate & Chill</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
  <style>
    :root{
      --bg: #0f1724; --panel: rgba(255,255,255,0.04);
      --accent: #ffd369; --muted: rgba(255,255,255,0.8);
      --green: #2ecc71; --red: #e74c3c; --yellow:#f39c12;
    }
    body{
      margin:0; font-family: Inter, system-ui, Arial; color:#fff;
      background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.65)),
                  url('{{ url_for("static", filename="images/home_bg.png") }}') center/cover fixed no-repeat;
    }
    .container{ max-width:1200px; margin:28px auto; padding:18px; }
    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
    header h1{ margin:0; font-size:20px; }

    .floor { position:relative; height:auto; margin-bottom:30px; display:flex; flex-wrap:wrap; justify-content:center; gap:20px; }
    .table { border-radius:12px; font-weight:800; min-width:120px; min-height:70px; display:flex; flex-direction:column; justify-content:center; align-items:center; cursor:pointer; transition:.15s; padding:8px; text-align:center; }
    .table.available{ background:var(--green); color:#042612; }
    .table.reserved{ background:var(--red); color:#fff; }
    .table.selected { outline:4px solid rgba(255,255,255,0.3); transform:scale(1.05); }

    .panel { background:rgba(0,0,0,0.6); padding:14px; border-radius:10px; margin-top:20px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { padding:8px; border-bottom:1px solid rgba(255,255,255,0.06); font-size:13px; vertical-align:top; }
    button { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; font-weight:700; }

    .btn-pay { background:var(--accent); color:#000; }
    .btn-delete { background:#e74c3c; color:#fff; }
    .btn-update { background:#3498db; color:#fff; }

    .small-btn{ background:var(--accent); color:#000; padding:6px 8px; border-radius:6px; cursor:pointer; font-weight:700; }
    .btn{ background:var(--accent); color:#000; padding:10px 14px; border-radius:8px; font-weight:800; }

    .menu-list{ display:grid; gap:8px; max-height:360px; overflow:auto; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .menu-card{ display:flex; gap:8px; background:rgba(255,255,255,0.05); padding:8px; border-radius:8px; align-items:center; }
    .menu-card img{ width:70px; height:70px; object-fit:cover; border-radius:8px; }

    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:99999; padding:16px; pointer-events: auto; }
    .modal.open{ display:flex; }
    .modal-card{ width:520px; max-width:96%; background:#fff; color:#000; padding:18px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.4); z-index:100000; pointer-events: auto; }
    .modal-card h3{ margin-top:0; }
    .gcash-qr{ max-width:100%; height:auto; border-radius:8px; display:block; margin:8px 0; }

    #successPopup { position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,.6); z-index:100001; pointer-events:auto; }
    #successPopup .box { background:#fff; color:#000; padding:20px 30px; font-size:18px; border-radius:10px; font-weight:700; text-align:center; }
    #successPopup .ok-btn { margin-top:12px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:var(--accent); color:#000; font-weight:700; }

    .order-list { font-size:13px; margin:6px 0; padding-left:12px; }
    .order-toggle { cursor:pointer; color:var(--accent); text-decoration:underline; background:transparent; border:none; padding:0; }

    .modal *, #successPopup * { pointer-events: auto; }

    @media(max-width:980px){ .menu-list{ grid-template-columns: 1fr; } .table { min-width:100px; } }
  </style>
</head>
<body>
<div class="container">

<header>
  <h1>Welcome, {{ session.username }}</h1>
  <a href="{{ url_for('logout') }}" class="small-btn" type="button">Logout</a>
</header>

<!-- FLOOR MAP -->
<div class="panel floor" id="floorMap">
  {% for t in tables %}
    <div class="table {% if t.status=='available' %}available{% else %}reserved{% endif %}" data-id="{{ t.id }}" data-number="{{ t.table_number }}" data-capacity="{{ t.capacity }}" role="button" tabindex="0">
      <div style="font-size:14px">#{{ t.table_number }}</div>
      <div style="font-size:18px; margin-top:6px;">{{ t.capacity }}persons</div>
      <div style="font-size:12px; opacity:.9; margin-top:6px;">{% if t.status=='available' %}Available{% else %}Reserved{% endif %}</div>
    </div>
  {% endfor %}
</div>

<!-- BOOKING PANEL -->
<div class="panel" id="bookingPanel">
  <h3>Booking</h3>
  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <input type="date" id="res_date">
    <select id="res_time">{% for t in times %}<option value="{{ t }}">{{ t }}</option>{% endfor %}</select>
    <input type="number" id="res_people" value="1" min="1" style="width:90px;">
    <div style="margin-left:auto;">Table: <strong id="selectedTable">None</strong></div>
  </div>

  <h4 style="margin-top:15px;">Selected Items</h4>
  <div style="max-height:140px; overflow:auto; background:rgba(255,255,255,0.03); padding:8px; border-radius:8px;">
    <ul id="selectedList" style="list-style:none; padding:0; margin:0;"></ul>
  </div>

  <div style="margin-top:10px;">Total: ₱<span id="totalAmount">0.00</span></div>

  <div style="margin-top:15px;">
    <button id="bookBtn" class="btn" type="button" disabled>Book now</button>
  </div>
</div>

<!-- MENU PANEL -->
<div class="panel">
  <h3>Menu</h3>

  <!--  THREE-COLUMN GRID  -->
  <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px;">

    <!-- =====  DRINKS  ===== -->
    <div class="menu-column">
      <h4 style="margin:0 0 8px 0; color:var(--accent); font-size:18px;">Drinks</h4>
      <div class="menu-list" id="drinksList">
        {% for m in drinks %}
          <div class="menu-card" data-id="{{ m.id }}" data-name="{{ m.name }}" data-price="{{ m.price }}">
            <img src="{{ url_for('static', filename='images/drinks/' ~ m.image) }}" alt="{{ m.name }}">
            <div style="flex:1">
              <h5 style="margin:0;">{{ m.name }}</h5>
              <p style="margin:2px 0 0 0;">₱{{ m.price }}</p>
            </div>
            <button class="small-btn add-item" type="button">Add</button>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- =====  MAIN FOOD  ===== -->
    <div class="menu-column">
      <h4 style="margin:0 0 8px 0; color:var(--accent); font-size:18px;">Main Food</h4>
      <div class="menu-list" id="mainList">
        {% for m in main_foods %}
          <div class="menu-card" data-id="{{ m.id }}" data-name="{{ m.name }}" data-price="{{ m.price }}">
            <img src="{{ url_for('static', filename='images/main/' ~ m.image) }}" alt="{{ m.name }}">
            <div style="flex:1">
              <h5 style="margin:0;">{{ m.name }}</h5>
              <p style="margin:2px 0 0 0;">₱{{ m.price }}</p>
            </div>
            <button class="small-btn add-item" type="button">Add</button>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- =====  DESSERTS  ===== -->
    <div class="menu-column">
      <h4 style="margin:0 0 8px 0; color:var(--accent); font-size:18px;">Desserts</h4>
      <div class="menu-list" id="dessertsList">
        {% for m in desserts %}
          <div class="menu-card" data-id="{{ m.id }}" data-name="{{ m.name }}" data-price="{{ m.price }}">
            <img src="{{ url_for('static', filename='images/desserts/' ~ m.image) }}" alt="{{ m.name }}">
            <div style="flex:1">
              <h5 style="margin:0;">{{ m.name }}</h5>
              <p style="margin:2px 0 0 0;">₱{{ m.price }}</p>
            </div>
            <button class="small-btn add-item" type="button">Add</button>
          </div>
        {% endfor %}
      </div>
    </div>

  </div><!-- /three-column grid -->
</div><!-- /panel -->

<!-- RESERVATIONS PANEL -->
<div class="panel">
  <h3>Your Reservations</h3>
  <table id="reservationsTable">
    <thead>
      <tr>
        <th>#</th><th>Name</th><th>Time</th><th>Table</th><th>People</th><th>Items</th><th>Total</th><th>Status</th><th>Payment</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in reservations %}
      <tr data-reservation='{{ r|tojson }}'>
        <td>{{ r.id }}</td>
        <td>{{ r.name or session.username }}</td>
        <td>{{ r.time }}</td>
        <td>{{ r.table_id or 'N/A' }}</td>
        <td>{{ r.people }}</td>
        <td>
          {% set items = r.get('items', []) %}
          {% if items|length %}
            <ul style="margin:0; padding-left:14px;">
            {% for it in items %}
              <li>{{ it.name }} x{{ it.qty }} — ₱{{ it.price }}</li>
            {% endfor %}
            </ul>
          {% else %}
            —
          {% endif %}
        </td>
        <td>₱{{ r.total or '0.00' }}</td>
        <td class="res-status">{{ r.status }}</td>
        <td class="res-payment">
          {% if r.payment_status == 'paid' %}
            <strong style="color:var(--green)">Paid</strong>
          {% else %}
            <strong style="color:var(--yellow)">{{ r.payment_method or 'none' }}</strong>
            <div><button class="btn-pay pay-now" data-id="{{ r.id }}" type="button">Pay</button></div>
          {% endif %}
        </td>
        <td>
          <button class="btn-update update-res" type="button">Update</button>
            <input type="hidden" name="reservation_id" value="{{ r.id }}">
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- UPDATE RESERVATION MODAL (ADDED) -->
<div id="updateModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h3>Edit Reservation</h3>
    <form id="updateForm">
      <input type="hidden" id="upd_res_id" name="reservation_id">
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <label style="flex:1">
          Date<br>
          <input type="date" id="upd_date" name="date" required>
        </label>
        <label style="flex:1">
          Time<br>
          <select id="upd_time" name="time">{% for t in times %}<option value="{{ t }}">{{ t }}</option>{% endfor %}</select>
        </label>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <label>
          People<br>
          <input type="number" id="upd_people" name="people" min="1" value="1" required style="width:110px;">
        </label>
        <label style="flex:1;">
          Table<br>
          <select id="upd_table" name="table_id"></select>
        </label>
      </div>
      <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" class="small-btn" id="upd_cancel">Cancel</button>
        <button type="submit" class="btn">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div id="paymentModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h3>Choose Payment Method</h3>
    <div id="paymentOptions" style="display:flex; gap:8px; margin-top:8px;">
      <button id="modalCash" class="small-btn" type="button">Cash</button>
      <button id="modalGcash" class="small-btn" type="button">GCash</button>
    </div>
    <div id="paymentContent" style="margin-top:12px;"></div>
    <div style="display:flex; justify-content:flex-end; margin-top:12px;">
      <button id="paymentCancel" class="small-btn" type="button">Cancel</button>
    </div>
  </div>
</div>

<!-- SUCCESS POPUP -->
<div id="successPopup">
  <div class="box">
    <div id="successMessage">Payment Successful</div>
    <button class="ok-btn" type="button">OK</button>
  </div>
</div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function(){
    let selectedItems=[], selectedTableId=null, payReservationId=null;
    

    /* ---------- EXISTING FUNCTIONS (unchanged) ---------- */
    function renderSelectedItems(){
        const list=$("#selectedList"); list.empty(); let total=0;
        if(selectedItems.length===0){ list.append("<li style='opacity:.6'>No items selected</li>"); $("#totalAmount").text('0.00'); checkBookBtn(); return; }
        selectedItems.forEach((it,idx)=>{
            list.append(`<li style="display:flex; justify-content:space-between;">
                <div>${it.name} x${it.qty} — ₱${(it.price*it.qty).toFixed(2)}</div>
                <div>
                    <button class="minus" data-idx="${idx}" type="button">-</button>
                    <button class="plus" data-idx="${idx}" type="button">+</button>
                    <button class="remove" data-idx="${idx}" type="button">Remove</button>
                </div>
            </li>`); total+=it.price*it.qty;
        });
        $("#totalAmount").text(total.toFixed(2));
        checkBookBtn();
    }
    function checkBookBtn(){ $("#bookBtn").prop("disabled",!(selectedItems.length && selectedTableId && $("#res_date").val())); }
    function showSuccess(msg){ $("#successMessage").text(msg); $("#successPopup").fadeIn(200); setTimeout(()=>$("#successPopup").fadeOut(200),1800); }

    /* ---------- booking / menu interactions (unchanged) ---------- */
    $(document).on('click', ".table.available", function(){
        $(".table").removeClass("selected"); $(this).addClass("selected");
        selectedTableId=$(this).data("id");
        $("#selectedTable").text(`#${$(this).data("number")} (${$(this).data("capacity")}p)`);
        checkBookBtn();
    });

    $(".menu-list").on("click",".add-item",function(){
        const card=$(this).closest(".menu-card"), id=card.data("id"), name=card.data("name"), price=parseFloat(card.data("price"));
        const existing=selectedItems.find(x=>String(x.id)===String(id)); if(existing) existing.qty++; else selectedItems.push({id,name,price,qty:1});
        renderSelectedItems();
    });

    $("#selectedList").on("click",".minus,.plus,.remove",function(){
        const idx=$(this).data("idx");
        if($(this).hasClass("minus") && selectedItems[idx].qty>1) selectedItems[idx].qty--;
        else if($(this).hasClass("plus")) selectedItems[idx].qty++;
        else if($(this).hasClass("remove")) selectedItems.splice(idx,1);
        renderSelectedItems();
    });

    function convertTo24Hour(timeStr) {
        try{
            let parts = timeStr.split('-');
            let t = parts[1];
            let hours = parseInt(t.split(':')[0]);
            let minutes = t.split(':')[1].slice(0,2);
            let ampm = t.slice(-2).toLowerCase();
            if(ampm === "pm" && hours !== 12) hours += 12;
            if(ampm === "am" && hours === 12) hours = 0;
            return `${hours.toString().padStart(2,'0')}:${minutes}`;
        }catch(e){ return timeStr; }
    }

    /* ---------- load reservations (unchanged) ---------- */
    function loadReservations(){
    $.getJSON("/get_reservations", function(response){
        const tbody = $("#reservationsTable tbody");
        tbody.empty();
        if(response.success && response.reservations && response.reservations.length){
            response.reservations.forEach(r => addReservationRow(r));
        } else {
            tbody.append("<tr><td colspan='10' style='text-align:center; opacity:.6'>No reservations yet</td></tr>");
        }
    }).fail(function(jqxhr, textStatus, error){
        console.error("GET /get_reservations failed:", jqxhr.status, jqxhr.responseText || error);
    });
}



    /* ---------- BOOK (unchanged) ---------- */
    $("#bookBtn").click(function(){
        const date = $("#res_date").val(),
              timeRaw = $("#res_time").val(),
              people = parseInt($("#res_people").val(),10) || 1;

        if(!date || !timeRaw || !people) { alert("Fill date/time/people"); return; }

        const time = convertTo24Hour(timeRaw);

        const payload = { table_id: selectedTableId, date, time, people, items: selectedItems };

        $.ajax({
            url: "{{ url_for('book_reservation') }}",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(payload),
            success: function(response){
                if(response.success){
                    showSuccess("Reservation Created!");
                    const newId = response.reservation_id || response.id || Date.now();
                    const total = selectedItems.reduce((s,it)=>s + (it.price*it.qty),0);
                    const reservationToShow = {
                        id: newId, name: "{{ session.username|e }}", time: `${date} ${time}`, table_id: selectedTableId,
                        people, status: response.status || 'Pending', payment_method: response.payment_method || 'none',
                        payment_status: response.payment_status || 'unpaid', items: selectedItems.map(it=>({name:it.name,qty:it.qty,price:it.price})),
                        total: total.toFixed(2)
                    };
                    addReservationRow(reservationToShow);
                    
                    // --- mark table as reserved on floor map with date and time ---
if(selectedTableId){
    const tEl = $(`.table[data-id='${selectedTableId}']`);
    tEl.removeClass("available selected").addClass("reserved");
    tEl.html(`Reserved<br>${date} ${time}`);
}

                    
                    // clear UI
                    selectedItems = []; renderSelectedItems(); $(".table").removeClass("selected"); selectedTableId=null;
                    $("#selectedTable").text('None'); $("#res_date").val(''); $("#res_time").prop('selectedIndex',0); $("#res_people").val(1);
                    checkBookBtn();
                } else {
                    alert("Reservation failed: " + (response.error || 'unknown'));
                }
            },
            error: function(xhr, textStatus, errorThrown){
                console.error("POST {{ url_for('book_reservation') }} failed:", xhr.status, xhr.responseText || errorThrown);
                alert("Booking failed — check browser console for server response (500).");
            }
        });
    });

    /* ---------- PAYMENT handlers (unchanged) ---------- */
   // Open payment modal for a reservation
$(document).on('click', '.pay-now', function() {
    payReservationId = $(this).data('id'); // this comes from the reservation row/button
    if (!payReservationId) return alert("Reservation not selected");

    $("#paymentModal").fadeIn(200);
    centerPopup("#paymentModal");

    // Reset modal content
    $("#paymentContent").empty();
    $("#paymentOptions").show();
});

// Cancel button closes modal
$(document).on('click', '#paymentCancel', function() {
    $("#paymentModal").fadeOut(200);
    payReservationId = null;
    $("#paymentContent").empty();
});

// Cash payment
$(document).on('click', '#modalCash', function() {
    if (!payReservationId) return alert("Reservation not selected");

    $("#paymentOptions").hide();
    $("#paymentContent").html(`
        <p style="font-weight:700;">Pay at counter</p>
        <button id="cashOk" class="btn" type="button">OK</button>
        <button id="cashCancelInner" class="btn" type="button">Cancel</button>
    `);
});

// Cash OK
$(document).on('click', '#cashOk', function() {
    if (!payReservationId) return alert("Reservation not selected");

    $.post("{{ url_for('submit_payment') }}", {
        reservation_id: payReservationId,
        payment_method: 'cash'
    }, function(response) {
        if (response.success) {
            updateReservationRow(payReservationId, 'Paid', 'Cash');
            $("#paymentModal").fadeOut(200);
            showSuccess("Pay at counter");
        } else {
            alert("Payment failed: " + response.error);
        }
    }).fail(function(jqxhr) {
        console.error("submit_payment failed:", jqxhr.status, jqxhr.responseText);
        alert("Payment failed — check console.");
    });
});

// Cash Cancel
$(document).on('click', '#cashCancelInner', function() {
    $("#paymentContent").empty();
    $("#paymentOptions").show();
});

// GCash payment
$(document).on('click', '#modalGcash', function() {
    if (!payReservationId) return alert("Reservation not selected");

    $("#paymentOptions").hide();
    $("#paymentContent").html(`
        <p style="font-weight:700; text-align:center;">Pay via GCash</p>
        <img src="{{ url_for('static', filename='gcash_qr.png') }}" 
             alt="GCash QR" style="width:200px; display:block; margin:10px auto;">
        <button id="gcashOk" class="btn" type="button">OK</button>
        <button id="gcashCancelInner" class="btn" type="button">Cancel</button>
    `);
});

// GCash OK
$(document).on('click', '#gcashOk', function() {
    if (!payReservationId) return alert("Reservation not selected");

    $.post("{{ url_for('submit_payment') }}", {
        reservation_id: payReservationId,
        payment_method: 'gcash'
    }, function(response) {
        if (response.success) {
            updateReservationRow(payReservationId, 'Paid', 'GCash');
            $("#paymentModal").fadeOut(200);
            showSuccess("Payment via GCash successful");
        } else {
            alert("Payment failed: " + response.error);
        }
    }).fail(function(jqxhr) {
        console.error("submit_payment failed:", jqxhr.status, jqxhr.responseText);
        alert("Payment failed — check console.");
    });
});

/* ===== OTP POP-UP BEFORE PAYMENT ===== */
async function otpThenPay(reservationId, method) {
  // 1. ask server for OTP (it returns it in this demo)
  const {otp: code} = await fetch("{{ url_for('send_otp') }}", {method: "POST"})
                              .then(r => r.json()).then(d => d.success ? d : Promise.reject());
  // 2. show prompt
  const supplied = prompt(`Enter the 6-digit code shown below to confirm payment:\n\n${code}`);
  if (!supplied) return;  // user cancelled
  // 3. verify
  const ok = await fetch("{{ url_for('check_otp') }}", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({otp: supplied})
  }).then(r => r.json());
  if (!ok.success) { alert(ok.error || "Wrong code"); return; }
  // 4. OTP correct – proceed with real payment
  $.post("{{ url_for('submit_payment') }}", {reservation_id: reservationId, payment_method: method}, r => {
      if (r.success) { updateReservationRow(reservationId, 'Paid', method); $("#paymentModal").fadeOut(200); showSuccess("Payment success"); }
      else { alert("Payment failed: " + r.error); }
  });
}
/* replace old GCash / Cash click handlers */
$(document).off("click", "#modalCash").on("click", "#modalCash", () => otpThenPay(payReservationId, 'cash'));
$(document).off("click", "#modalGcash").on("click", "#modalGcash", () => otpThenPay(payReservationId, 'gcash'));
/* ===== /OTP POP-UP ===== */

// GCash Cancel
$(document).on('click', '#gcashCancelInner', function() {
    $("#paymentContent").empty();
    $("#paymentOptions").show();
});

// Center popup
function centerPopup(selector){
    const $popup = $(selector);
    const top = ($(window).height() - $popup.outerHeight()) / 2;
    const left = ($(window).width() - $popup.outerWidth()) / 2;
    $popup.css({position: 'fixed', top: top + 'px', left: left + 'px'});
}

$(window).resize(function(){ 
    centerPopup("#paymentModal"); 
});
});
    /* ---------- NEW: Setup table list for update modal ---------- */
    function populateTableOptions(selectEl){
        // build options from floor map .table elements
        selectEl.empty();
        $("#floorMap .table").each(function(){
            const id = $(this).data("id");
            const number = $(this).data("number");
            const capacity = $(this).data("capacity");
            selectEl.append(`<option value="${id}">#${number} (${capacity}p)</option>`);
        });
    }

    /* ---------- NEW: Open update modal and populate values ---------- */
    $(document).on('click', '.update-res', function(){
        const tr = $(this).closest('tr');
        let data = tr.data('reservation');

        // If data not stored in jQuery data (string), try parse attr
        if(!data){
            try{ data = JSON.parse(tr.attr('data-reservation')); }catch(e){ data = null; }
        }
        if(!data){
            alert("Failed to read reservation data.");
            return;
        }

        // prepare table options
        populateTableOptions($("#upd_table"));

        // populate fields (date/time splitting if needed)
        $("#upd_res_id").val(data.id || '');
        // if time includes date prefix (we used `${date} ${time}`), attempt to split
        if(typeof data.time === 'string' && data.time.includes(' ')){
            const parts = data.time.split(' ');
            $("#upd_date").val(parts[0]);
            $("#upd_time").val(parts[1]);
        } else {
            // if server sent separate date/time fields, prefer them
            $("#upd_date").val(data.date || '');
            $("#upd_time").val(data.time || '');
        }
        $("#upd_people").val(data.people || 1);
        $("#upd_table").val(data.table_id || $("#upd_table option:first").val());

        // open modal
        $("#updateModal").fadeIn(120).addClass('open');
    });

    /* ---------- NEW: Cancel update ---------- */
    $("#upd_cancel").on('click', function(){ $("#updateModal").fadeOut(120).removeClass('open'); });

// Trigger update when the form is submitted (Save button)
$("#updateForm").on('submit', function(e){
    e.preventDefault();

    const reservation_id = $("#upd_res_id").val();
    const date = $("#upd_date").val();
    const timeRaw = $("#upd_time").val();
    const people = parseInt($("#upd_people").val(), 10) || 1;
    const table_id = $("#upd_table").val();

    if(!reservation_id || !date || !timeRaw || !people || !table_id){
        alert("Please fill all fields.");
        return;
    }

    // Combine date + time for backend
    const payload = {
        id: reservation_id,
        time: date + ' ' + timeRaw,
        people,
        table_id
    };

    $.ajax({
        url: "{{ url_for('update_reservation') }}",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(payload),
        success: function(response){
            if(response.success){
                // Find the table row for this reservation
                const tr = $("#reservationsTable tbody tr").filter(function(){
                    const d = $(this).data('reservation');
                    return d && String(d.id) === String(reservation_id);
                });

                // Merge new data with existing row data
                let rowData = tr.data('reservation') || {};
                rowData = Object.assign({}, rowData, payload, response.reservation || {});
                tr.attr('data-reservation', JSON.stringify(rowData));
                tr.data('reservation', rowData);

                // Update visible cells
                tr.find('td').eq(2).text(date + ' ' + timeRaw);
                tr.find('td').eq(3).text(table_id);
                tr.find('td').eq(4).text(people);

                // Update items list if returned
                if(response.reservation && response.reservation.items){
                    const itemsHtml = response.reservation.items.length
                        ? `<ul style="margin:0; padding-left:14px;">` +
                          response.reservation.items.map(it => `<li>${it.name} x${it.qty} — ₱${it.price}</li>`).join('') +
                          `</ul>`
                        : "—";
                    tr.find('td').eq(5).html(itemsHtml);
                }

                // Update total if returned
                if(response.reservation && response.reservation.total){
                    tr.find('td').eq(6).text(`₱${response.reservation.total}`);
                }

                // Show centered success popup
                const $popup = $(`
                    <div id="updateSuccessPopup" style="
                        position:fixed; 
                        inset:0; 
                        display:flex; 
                        justify-content:center; 
                        align-items:center; 
                        background:rgba(0,0,0,0.6); 
                        z-index:100002;
                    ">
                        <div style="
                            background:#2ecc71; 
                            color:#fff; 
                            padding:20px 30px; 
                            font-size:18px; 
                            border-radius:10px; 
                            font-weight:700;
                            text-align:center;
                        ">Reservation updated!</div>
                    </div>
                `);
                $("body").append($popup);
                setTimeout(() => { $popup.fadeOut(300, ()=>$popup.remove()); }, 1500);

                // Close modal
                $("#updateModal").fadeOut(120).removeClass('open');

            } else {
                alert("Update failed: " + (response.error || 'unknown'));
            }
        },
        error: function(xhr, textStatus, errorThrown){
            console.error("Update request failed:", xhr.status, xhr.responseText || errorThrown);
            alert("Update failed — check console for server response.");
        }
    });
});




    /* ---------- INITIALIZE ---------- */
    renderSelectedItems();
    loadReservations();


/* ---------- existing helper functions to render reservation rows ---------- */
function addReservationRow(res){
    const reservation = Object.assign({id:res.id, time:res.time || res.date || '', table_id:res.table_id||'N/A', people:res.people||1, status:res.status||'Pending', payment_method:res.payment_method||'none', items:res.items||[], total: res.total||'0.00'}, res);

    let itemsHtml = "—";
    if(reservation.items && reservation.items.length){
        itemsHtml = `<ul style="margin:0; padding-left:14px;">`;
        reservation.items.forEach(it=>{
            itemsHtml += `<li>${it.name} x${it.qty} — ₱${it.price}</li>`;
        });
        itemsHtml += `</ul>`;
    }

    let paymentHtml = '';
    if(reservation.payment_status === 'paid' || reservation.payment_status === 'Paid'){
        paymentHtml = `<strong style="color:var(--green)">Paid</strong>`;
    } else {
        paymentHtml = `<strong style="color:var(--yellow)">${reservation.payment_method||'none'}</strong>
            <div><button class="btn-pay pay-now" data-id="${reservation.id}" type="button">Pay</button></div>`;
    }

    const tr = $(`
        <tr data-reservation='${JSON.stringify(reservation)}'>
            <td>${reservation.id}</td>
            <td>${reservation.name || ''}</td>
            <td>${reservation.time}</td>
            <td>${reservation.table_id}</td>
            <td>${reservation.people}</td>
            <td>${itemsHtml}</td>
            <td>₱${reservation.total}</td>
            <td class="res-status">${reservation.status}</td>
            <td class="res-payment">${paymentHtml}</td>
            <td>
                <button class="btn-update update-res" type="button">Update</button>
                <form method="POST" action="{{ url_for('delete_reservation') }}" style="display:inline;">
                    <input type="hidden" name="reservation_id" value="${reservation.id}">
                </form>
            </td>
        </tr>
    `);

    const tbody = $("#reservationsTable tbody");
    tbody.find("tr").each(function(){ if($(this).find('td').length==1) $(this).remove(); });
    tbody.append(tr);
}

function updateReservationRow(id,status,method){
    const row=$("#reservationsTable tbody tr").filter(function(){
        try{ const data = $(this).data("reservation"); return data && data.id==id; }catch(e){ return false; }
    });
    row.find(".res-status").text(status);
    row.find(".res-payment").html(`<strong style="color:${status==='Paid'?'var(--green)':'var(--yellow)'}">${method}</strong>`);
    if(status==='Paid') row.addClass("reserved");
}

</script>
</body>
</html>
