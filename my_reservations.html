{% extends "base.html" %}
{% block title %}My Reservations - Plate & Chill{% endblock %}

{% block content %}
<style>
  .top-actions { display:flex; justify-content:space-between; align-items:center; max-width:1000px; margin:0 auto 12px auto; }
  .exit-btn { background:#c59a3b; color:#fff; padding:8px 12px; border-radius:8px; text-decoration:none; }
  .card { background: rgba(0,0,0,0.55); padding:20px; border-radius:10px; color:#fff; max-width:1000px; margin:auto 0 20px 0; }
  .btn { background:#b58a43;color:#fff;padding:6px 10px;border-radius:6px;border:none;cursor:pointer;margin-top:6px; }
  .btn-cancel { background:red; color:#fff; }
  .btn-confirm { background:#2d7a2d; color:#fff; }
  .btn-small { padding:6px 8px; border-radius:6px; font-size:14px; margin-left:6px; }
  table { width:100%; border-collapse:collapse; color:#fff; }
  th, td { padding:10px; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; vertical-align:top; }
  .small { font-size:13px; color:rgba(255,255,255,0.7); }
  .item-line { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
  .item-name { flex:1; }
  .item-right { white-space:nowrap; }
  .meta { color: rgba(255,255,255,0.6); font-size:13px; margin-top:6px; }

  #updateModal {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.5);
    z-index:2000;
  }
  #updateModal .modal-card {
    background:#222;
    width:420px;
    margin:120px auto;
    padding:22px;
    border-radius:12px;
    color:white;
    box-shadow:0 0 12px rgba(0,0,0,0.6);
  }
  #updateModal input, #updateModal select {
    width:100%;
    padding:8px;
    border-radius:6px;
    border:none;
    margin-top:4px;
    background:#333;
    color:white;
  }
</style>

<div class="top-actions" style="max-width:1000px;">
  <h2 style="color:#d6a73e; margin:0;">My Reservations</h2>
  <a class="exit-btn" href="{{ url_for('reservations') }}">Exit → Book Table</a>
</div>

<main style="max-width:1000px;margin:0 auto 40px auto;">
  <div class="card">
    {% if not reservations %}
      <div class="small">You have no reservations yet.</div>
    {% else %}
      <table>
        <thead>
          <tr>
            <th style="width:260px">Date & Time</th>
            <th style="width:110px">Persons</th>
            <th style="width:120px">Status</th>
            <th>Items</th>
            <th style="width:210px">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for r in reservations %}
          <tr>
            <td>
              {% if r.time %}
                {% if r.time is string %}
                  {{ r.time }}
                {% else %}
                  {{ r.time.strftime('%Y-%m-%d %I:%M %p') }} — {{ r.time.strftime('%A') }}
                {% endif %}
              {% else %}
                —
              {% endif %}
            </td>

            <td>{{ r.people }}</td>
            <td>{{ r.status or 'pending' }}</td>

            <td>
              {% if r.items_parsed %}
                {% for it in r.items_parsed %}
                  <div class="item-line">
                    <div class="item-name">
                      <strong>{{ it.name if it.name is defined else it.id }}</strong>
                      <div class="small">× {{ it.qty }}</div>
                    </div>
                    <div class="item-right small">
                      {% if it.price %} ₱{{ (it.price * it.qty)|round(2) }} {% else %} — {% endif %}
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="small">No items selected.</div>
              {% endif %}
              <div class="meta">Reservation by: <strong>{{ session.get('username') }}</strong></div>
            </td>

            <td>
              <div style="display:flex; gap:8px;">

                <button class="btn btn-small"
                  onclick='openUpdateModal({
                    id: "{{ r.id }}",
                    people: "{{ r.people }}",
                    date: "{{ r.time.strftime("%Y-%m-%d") if r.time else "" }}",
                    time: "{{ r.time.strftime("%H:%M") if r.time else "" }}"
                  })'>
                  Update
                </button>

                <form method="POST" action="{{ url_for('confirm_reservation') }}#orders">
                  <input type="hidden" name="reservation_id" value="{{ r.id }}">
                  <button class="btn btn-confirm" type="submit">Confirm</button>
                </form>

                <form method="POST" action="{{ url_for('delete_reservation') }}">
                  <input type="hidden" name="reservation_id" value="{{ r.id }}">
                  <button class="btn btn-cancel" type="submit">Delete</button>
                </form>

              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>

  <a id="orders"></a>

  <div class="card" style="margin-top:18px;">
    <h3 style="margin-top:0;">My Orders</h3>
    {% if not orders %}
      <div class="small">You have no orders yet.</div>
    {% else %}
      <table>
        <thead>
          <tr>
            <th style="width:220px">Reservation (Date / Time / Day)</th>
            <th>Items</th>
            <th style="width:110px">Total</th>
            <th style="width:180px">Created (Date / Time / Day)</th>
            <th style="width:150px">User</th>
            <th style="width:110px">Status</th>
            <th style="width:80px">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for o in orders %}
          <tr>
            <td>
              {% if o.reservation_time %}
                {% if o.reservation_time is string %}
                  {{ o.reservation_time }}
                {% else %}
                  {{ o.reservation_time.strftime('%Y-%m-%d %I:%M %p') }} — {{ o.reservation_time.strftime('%A') }}
                {% endif %}
              {% else %} — {% endif %}
            </td>

            <td class="small">
              {% if o.items_parsed %}
                {% for it in o.items_parsed %}
                  <div class="item-line">
                    <div style="flex:1;">
                      <strong>{{ it.name if it.name is defined else it.id }}</strong>
                      <div class="small">× {{ it.qty }}</div>
                    </div>
                    <div class="item-right small">
                      ₱{{ (it.price * it.qty)|round(2) if it.price else "—" }}
                    </div>
                  </div>
                {% endfor %}
              {% else %} — {% endif %}
            </td>

            <td>₱{{ (o.total or 0)|round(2) }}</td>

            <td>
              {% if o.created_at %}
                {{ o.created_at }}
                {% if o.created_at is not string %} — {{ o.created_at.strftime('%A') }} {% endif %}
              {% else %} — {% endif %}
            </td>

            <td>{{ o.username or session.get('username') }}</td>

            <td>{{ o.reservation_status or 'reserved' }}</td>

            <td>
              <form method="POST" action="{{ url_for('delete_order') }}">
                <input type="hidden" name="order_id" value="{{ o.id }}">
                <button class="btn btn-cancel" type="submit">Delete</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>
</main>

<div id="updateModal">
  <div class="modal-card">
    <h3 style="margin-top:0;">Update Reservation</h3>

    <form action="{{ url_for('update_reservation') }}" method="POST">
      <input type="hidden" name="reservation_id" id="upd_id">

      <label>Persons</label>
      <select name="people" id="upd_people" required>
        {% for i in range(1,11) %}
          <option value="{{ i }}">{{ i }} person{{ 's' if i>1 else '' }}</option>
        {% endfor %}
      </select>

      <label style="margin-top:12px;">Date</label>
      <input type="date" name="date" id="upd_date" required>

      <label style="margin-top:12px;">Time</label>
      <input type="time" name="time" id="upd_time" required>

      <div style="margin-top:18px; display:flex; gap:12px;">
        <button class="btn" type="submit">Save</button>
        <button class="btn" type="button" onclick="closeUpdateModal()" style="background:#777;">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
function openUpdateModal(data) {
  document.getElementById("updateModal").style.display = "block";

  document.getElementById("upd_id").value = data.id;
  document.getElementById("upd_people").value = data.people;
  document.getElementById("upd_date").value = data.date;
  document.getElementById("upd_time").value = data.time;
}

function closeUpdateModal() {
  document.getElementById("updateModal").style.display = "none";
}
</script>

{% endblock %}
