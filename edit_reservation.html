{% extends "base.html" %}
{% block title %}Reservations - Plate & Chill{% endblock %}

{% block content %}
<style>
  body.res-bg {
    background-image: url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1600&q=80') !important;
    background-size: cover !important;
    background-position: center !important;
    background-repeat: no-repeat !important;
    background-attachment: fixed !important;
    color: #fff;
  }

  main, section { background: rgba(0, 0, 0, 0.55); border-radius: 12px; padding: 20px; }
  .card { background: rgba(0, 0, 0, 0.6); padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); color: #fff; }
  input, select { width: 100%; padding: 8px; margin: 6px 0; border: none; border-radius: 6px; }
  .btn { background: #b58a43; border: none; color: #fff; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
  .btn:hover { background: #d4a44f; }

  #openMenuBtn {
    background: linear-gradient(180deg, rgba(20,20,20,0.95), rgba(10,10,10,0.9));
    color: #fff;
    padding: 10px 18px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.06);
    font-weight:700;
    letter-spacing:1px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.4);
  }

  #menuModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; }
  #menuModal .modal-card {
    background: rgba(10,10,10,0.95);
    max-width:920px;
    margin:40px auto;
    padding:18px;
    border-radius:10px;
    color:#fff;
  }

  .menu-grid {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }

  .menu-card {
    padding:10px;
    background: rgba(255,255,255,0.02);
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.04);
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  .menu-card .left { max-width:70%; }
  .menu-card .name { font-weight:600; }
  .menu-card .price { font-weight:700; min-width:80px; text-align:right; }

  .order-item {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    padding:6px 8px;
    border-bottom:1px dashed rgba(255,255,255,0.04);
  }
  .order-left { display:flex; align-items:center; gap:8px; min-width:0; }
  .order-name { font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:320px;}
  .order-controls { display:flex; gap:6px; align-items:center;}
  .small-btn { background:transparent; border:1px solid rgba(255,255,255,0.08); color:#fff; padding:4px 8px; border-radius:6px; cursor:pointer;}
  .small-btn:hover { background:rgba(255,255,255,0.02); }

  .qty-badge { font-weight:700; padding:4px 8px; border-radius:6px; background:rgba(255,255,255,0.03); min-width:36px; text-align:center; }

  .muted { color: rgba(255,255,255,0.6); font-size:13px; }

  @media (max-width:800px) {
    .menu-grid { grid-template-columns: 1fr; }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
  document.body.classList.add('res-bg');
});
</script>

<a href="{{ url_for('home') }}" class="back-home-inline" style="display:inline-block;margin-bottom:16px;text-decoration:none;font-weight:600;background:#b58a43;color:#fff;padding:8px 12px;border-radius:6px;">← Back to Home</a>

<section style="padding:40px 0;">
  <div style="max-width:1100px;margin:0 auto;">
    <div style="display:flex;gap:20px;flex-wrap:wrap;">
      <div style="flex:1;min-width:320px;">
        <div class="card">
          {% if not session.get('username') %}
            <h3>Register</h3>
            <form method="POST" action="{{ url_for('register') }}">
              <input type="text" name="username" placeholder="Full name" required>
              <input type="email" name="email" placeholder="Email" required>
              <input type="password" name="password" placeholder="Password" required>
              <button class="btn" type="submit" style="width:100%;margin-top:10px;">Register &amp; Login</button>
            </form>
          {% else %}
            <p>Logged in as <strong>{{ session.get('username') }}</strong></p>
            <a href="{{ url_for('logout') }}" class="btn" style="display:inline-block;margin-top:10px;">Logout</a>
          {% endif %}
        </div>

        <div class="card" style="margin-top:12px;">
          <h3>Book a Table</h3>
          <form id="resForm" method="POST" action="{{ url_for('create_reservation') }}">
            <label>People</label>
            <select name="people" required>
              {% for i in range(1,11) %}
                <option value="{{ i }}">{{ i }} person{{ 's' if i>1 else '' }}</option>
              {% endfor %}
            </select>

            <label>Date</label>
            <input type="date" name="date" required>

            <label>Time</label>
            <select name="time" required>
              {% for t in times %}
                <option value="{{ t }}">{{ t }}</option>
              {% endfor %}
            </select>

            <input type="hidden" name="items" id="reservation_items" value="">
            <div style="display:flex;gap:8px;margin-top:12px;">
              <button type="button" id="openMenuBtn">OPEN MENU</button>
              <button type="submit" class="btn" style="background:#2d7a2d;">Submit</button>
            </div>
          </form>
        </div>
      </div>

      <div style="flex:1;min-width:320px;">
        <div class="card">
          <h3>Your Upcoming</h3>
          <p>Reservations and orders will appear here after creation.</p>
          <p style="font-size:13px;color:rgba(255,255,255,0.6);">To view your personal list, go to <a href="{{ url_for('my_reservations') }}">My Reservations</a>.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<div id="menuModal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0">Select Items</h3>
      <div>
        <button id="closeMenuModal" class="btn" style="background:#b58a43;">Close</button>
      </div>
    </div>

    <div style="margin-top:12px;">
      <div class="menu-grid">
        {% for item in menu_items %}
        <div class="menu-card" data-id="{{ item.id }}" data-name="{{ item.name }}" data-price="{{ item.price }}">
          <div class="left">
            <div class="name">{{ item.name }}</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.6)">{{ item.category }}</div>
          </div>
          <div class="price">₱{{ item.price }}</div>
        </div>
        {% endfor %}
      </div>

      <div style="margin-top:18px;border-top:1px solid rgba(255,255,255,0.06);padding-top:12px;">
        <h4 style="margin:0 0 8px 0">Your Order</h4>
        <div id="orderList" style="min-height:60px; margin-bottom:8px;"></div>
        <div id="orderTotal" style="font-weight:600; margin-bottom:12px;"></div>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button id="confirmOrdersBtn" class="btn" style="background:#2d7a2d;">Confirm Orders</button>
          <button id="closeOrdersBtn" class="btn" style="background:#999;">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const openMenuBtn = document.getElementById('openMenuBtn');
  const menuModal = document.getElementById('menuModal');
  const closeMenuModal = document.getElementById('closeMenuModal');
  const closeOrdersBtn = document.getElementById('closeOrdersBtn');
  const confirmOrdersBtn = document.getElementById('confirmOrdersBtn');
  const orderList = document.getElementById('orderList');
  const orderTotal = document.getElementById('orderTotal');
  const reservationItems = document.getElementById('reservation_items');
  let orders = [];

  function findOrder(id) {
    return orders.findIndex(o => o.id === id);
  }

  function renderOrders() {
    orderList.innerHTML = '';
    let total = 0;
    if (orders.length === 0) {
      orderList.innerHTML = '<div class="muted">No items selected.</div>';
      orderTotal.textContent = 'Total: ₱0';
      reservationItems.value = JSON.stringify([]);
      return;
    }

    orders.forEach(o => {
      const row = document.createElement('div');
      row.className = 'order-item';

      const left = document.createElement('div');
      left.className = 'order-left';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = o.active !== false; 
      checkbox.style.width = '16px';
      checkbox.style.height = '16px';
      checkbox.addEventListener('change', () => {
        o.active = checkbox.checked;
        renderOrders();
      });

      const name = document.createElement('div');
      name.className = 'order-name';
      name.textContent = o.name;

      left.appendChild(checkbox);
      left.appendChild(name);

      const right = document.createElement('div');
      right.className = 'order-controls';

      const minus = document.createElement('button');
      minus.className = 'small-btn';
      minus.textContent = '−';
      minus.title = 'Decrease quantity';
      minus.addEventListener('click', () => {
        if (o.qty > 1) o.qty--;
        else {
          const idx = findOrder(o.id);
          if (idx > -1) orders.splice(idx,1);
        }
        renderOrders();
      });

      const qty = document.createElement('div');
      qty.className = 'qty-badge';
      qty.textContent = o.qty;

      const plus = document.createElement('button');
      plus.className = 'small-btn';
      plus.textContent = '+';
      plus.title = 'Increase quantity';
      plus.addEventListener('click', () => {
        o.qty++;
        renderOrders();
      });

      const edit = document.createElement('button');
      edit.className = 'small-btn';
      edit.textContent = 'Edit';
      edit.title = 'Set quantity';
      edit.addEventListener('click', () => {
        const val = prompt('Enter quantity for "' + o.name + '":', o.qty);
        const n = parseInt(val);
        if (!isNaN(n) && n > 0) {
          o.qty = n;
        }
        renderOrders();
      });

      const remove = document.createElement('button');
      remove.className = 'small-btn';
      remove.textContent = 'Remove';
      remove.title = 'Remove item';
      remove.addEventListener('click', () => {
        const idx = findOrder(o.id);
        if (idx > -1) orders.splice(idx,1);
        renderOrders();
      });

      const priceDiv = document.createElement('div');
      priceDiv.style.minWidth = '80px';
      priceDiv.style.textAlign = 'right';
      priceDiv.textContent = `₱${o.price * o.qty}`;

      right.appendChild(minus);
      right.appendChild(qty);
      right.appendChild(plus);
      right.appendChild(edit);
      right.appendChild(remove);
      right.appendChild(priceDiv);

      row.appendChild(left);
      row.appendChild(right);

      orderList.appendChild(row);

      if (o.active !== false) total += o.price * o.qty;
    });

    reservationItems.value = JSON.stringify(orders.filter(o => o.active !== false).map(o => ({ id: o.id, qty: o.qty })));
    orderTotal.textContent = `Total: ₱${total}`;
  }

  document.querySelectorAll('.menu-card').forEach(card => {
    card.addEventListener('click', () => {
      const id = parseInt(card.dataset.id);
      const name = card.dataset.name;
      const price = parseInt(card.dataset.price);
      const idx = findOrder(id);
      if (idx > -1) {
        orders[idx].qty++;
        orders[idx].active = true;
      } else {
        orders.push({ id, name, qty: 1, price, active: true });
      }
      renderOrders();
    });
  });

  openMenuBtn.onclick = () => menuModal.style.display = 'block';
  closeMenuModal.onclick = () => menuModal.style.display = 'none';
  closeOrdersBtn.onclick = () => menuModal.style.display = 'none';

  confirmOrdersBtn.onclick = async () => {
    const selected = orders.filter(o => o.active !== false);
    if (!selected.length) return alert('No items selected');
    let total = 0;
    selected.forEach(s => total += s.price * s.qty);

    try {
      const res = await fetch('{{ url_for("create_order") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: selected.map(s => ({ id: s.id, qty: s.qty })), total })
      });
      const payload = await res.json();
      if (payload && payload.ok) {
        alert('Orders confirmed and saved!');
        menuModal.style.display = 'none';
      } else {
        alert('Could not save orders: ' + (payload && payload.error ? payload.error : 'unknown'));
      }
    } catch (err) {
      alert('Error saving orders: ' + err);
    }
  };

  renderOrders();
</script>
{% endblock %}
